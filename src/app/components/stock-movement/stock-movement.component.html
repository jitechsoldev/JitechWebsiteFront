<!-- ✅ Centered Modal Background -->
<div
  *ngIf="isModalOpen"
  class="fixed inset-0 z-50 flex items-center justify-center"
>
  <!-- ✅ Modal Content -->
  <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
    <!-- ✅ Modal Header -->
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-extrabold text-blue-900">Stock Movement</h2>
      <button
        (click)="closeModal()"
        class="text-red-500 text-2xl hover:text-red-600 transition"
      >
        ✖
      </button>
    </div>

    <!-- ✅ Display Error Messages -->
    <div
      *ngIf="errors.length > 0"
      class="bg-red-100 border-l-4 border-red-600 p-3 mb-4 rounded-lg"
    >
      <h4 class="text-red-700 font-semibold">Please fix the following:</h4>
      <ul class="list-disc list-inside text-red-600">
        <li *ngFor="let error of errors">{{ error }}</li>
      </ul>
    </div>

    <!-- ✅ Stock Movement Form -->
    <form [formGroup]="stockMovementForm" (ngSubmit)="updateStock()">
      <!-- ✅ Product Selection -->
      <div class="mt-4">
        <label class="block font-semibold text-gray-700">Product Name:</label>
        <select
          formControlName="inventoryId"
          (change)="onProductChange($event)"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring focus:ring-blue-300"
        >
          <option *ngFor="let item of inventory" [value]="item._id">
            {{ item.productId.productName }} ({{ item.stockLevel }} in stock)
          </option>
        </select>
      </div>

      <!-- ✅ Change Type Selection -->
      <div class="mt-4">
        <label class="block font-semibold text-gray-700">Movement Type:</label>
        <select
          formControlName="type"
          (change)="generateSerialFields(); fetchAvailableSerialNumbers()"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring focus:ring-blue-300"
        >
          <option value="INCREASE">Incoming</option>
          <option value="DECREASE">Outgoing</option>
        </select>
      </div>

      <!-- ✅ Upload File for Serial Numbers (Only for Incoming) -->
      <div class="mt-4">
        <label class="block font-semibold text-gray-700">
          Upload Serial Numbers (Excel):
        </label>
        <input
          type="file"
          (change)="onFileUpload($event)"
          accept=".xls,.xlsx"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring focus:ring-blue-300"
        />
      </div>

      <!-- ✅ Stock Quantity Input -->
      <div class="mt-4">
        <label class="block font-semibold text-gray-700">Quantity:</label>
        <input
          type="number"
          formControlName="quantity"
          (input)="generateSerialFields(); fetchAvailableSerialNumbers()"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring focus:ring-blue-300"
        />
      </div>

      <!-- ✅ Serial Numbers Input for INCREASE -->
      <div
        *ngIf="
          requiresSerialNumber &&
          stockMovementForm.get('type')?.value === 'INCREASE' &&
          stockMovementForm.get('quantity')?.value > 0
        "
        class="mt-4"
      >
        <h4 class="font-semibold text-gray-700">Enter Serial Numbers:</h4>

        <!-- ✅ FormArray Wrapper -->
        <div formArrayName="serialNumbers">
          <div
            *ngFor="let sn of serialNumbersArray.controls; let i = index"
            class="mb-2"
          >
            <input
              [formControlName]="i"
              class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring focus:ring-blue-300"
              placeholder="Serial Number {{ i + 1 }}"
              (input)="updateFormValidation()"
            />
            <p *ngIf="sn.invalid && sn.touched" class="text-red-600 text-sm">
              ⚠️ Please enter a serial number.
            </p>
          </div>
        </div>
      </div>

      <!-- ✅ Serial Numbers Selection for DECREASE -->
      <div
        *ngIf="
          requiresSerialNumber &&
          stockMovementForm.get('type')?.value === 'DECREASE' &&
          availableSerialNumbers.length > 0
        "
        class="mt-4"
      >
        <h4 class="font-semibold text-gray-700">
          Select Serial Numbers to Remove:
        </h4>
        <div
          class="max-h-40 overflow-y-auto border border-gray-300 p-2 rounded-lg"
        >
          <div *ngFor="let serial of availableSerialNumbers">
            <label class="flex items-center">
              <input
                type="checkbox"
                [checked]="selectedSerialNumbers.includes(serial)"
                (change)="toggleSerialSelection(serial)"
                class="mr-2"
              />
              {{ serial }}
            </label>
          </div>
        </div>
      </div>

      <!-- ✅ Buttons -->
      <div class="mt-6 flex justify-end space-x-4">
        <button
          type="button"
          (click)="closeModal()"
          class="bg-gray-500 text-white px-5 py-2 rounded-lg hover:bg-gray-700 transition"
        >
          Cancel
        </button>

        <button
          (click)="updateStock(); closeModal()"
          [disabled]="!isFormValid()"
          class="px-5 py-2 rounded-lg transition duration-300 font-semibold"
          [ngClass]="
            isFormValid()
              ? 'bg-green-600 text-white hover:bg-green-700'
              : 'bg-gray-400 text-gray-200 cursor-not-allowed'
          "
        >
          Update Stock
        </button>
      </div>
    </form>
  </div>
</div>
