<!-- ✅ Modal Background (Hidden by Default) -->
<div
  *ngIf="isModalOpen"
  class="fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center z-50"
>
  <!-- ✅ Modal Content -->
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-lg w-full">
    <h2 class="text-2xl font-extrabold text-blue-900 mb-4">Stock Movement</h2>

    <!-- ✅ Display Error Messages Clearly -->
    <div
      *ngIf="errors.length > 0"
      class="bg-red-100 border-l-4 border-red-600 p-3 mb-4 rounded-lg"
    >
      <h4 class="text-red-700 font-semibold">
        Please fix the following errors:
      </h4>
      <ul class="list-disc list-inside text-red-600">
        <li *ngFor="let error of errors">{{ error }}</li>
      </ul>
    </div>

    <!-- ✅ Stock Movement Form -->
    <form [formGroup]="stockMovementForm" (ngSubmit)="updateStock()">
      <!-- ✅ Product Selection -->
      <div class="mt-4">
        <label class="block mb-2 font-semibold">Product Name:</label>
        <select
          formControlName="inventoryId"
          (change)="onProductChange($event)"
          class="w-full border border-gray-300 rounded-lg px-4 py-2"
        >
          <option *ngFor="let item of inventory" [value]="item._id">
            {{ item.productId.productName }} ({{ item.stockLevel }} in stock)
          </option>
        </select>
      </div>

      <!-- ✅ Change Type Selection -->
      <div class="mt-4">
        <label class="block mb-2 font-semibold">Movement Type:</label>
        <select
          formControlName="type"
          (change)="generateSerialFields(); fetchAvailableSerialNumbers()"
          class="w-full border border-gray-300 rounded-lg px-4 py-2"
        >
          <option value="INCREASE">Incoming</option>
          <option value="DECREASE">Outgoing</option>
        </select>
      </div>

      <!-- ✅ Upload File for Serial Numbers (Only for Incoming) -->
      <div class="mt-4">
        <label class="block mb-2 font-semibold"
          >Upload Serial Numbers (Excel):</label
        >
        <input
          type="file"
          (change)="onFileUpload($event)"
          accept=".xls,.xlsx"
          class="w-full border border-gray-300 rounded-lg px-4 py-2"
        />
      </div>

      <!-- ✅ Stock Quantity Input -->
      <div class="mt-4">
        <label class="block mb-2 font-semibold">Quantity:</label>
        <input
          type="number"
          formControlName="quantity"
          (input)="generateSerialFields(); fetchAvailableSerialNumbers()"
          class="w-full border border-gray-300 rounded-lg px-4 py-2"
        />
      </div>

      <!-- ✅ Serial Numbers Input for INCREASE -->
      <div
        *ngIf="
          stockMovementForm.value.type === 'INCREASE' &&
          stockMovementForm.value.quantity > 0
        "
        class="mt-4"
      >
        <h4 class="font-semibold">Serial Numbers:</h4>

        <!-- ✅ FormArray Wrapper -->
        <div formArrayName="serialNumbers">
          <div
            *ngFor="let sn of serialNumbersArray.controls; let i = index"
            class="mb-2"
          >
            <input
              [formControlName]="i"
              class="w-full border border-gray-300 rounded-lg px-4 py-2"
              placeholder="Serial Number {{ i + 1 }}"
              (input)="updateFormValidation()"
            />
            <p *ngIf="sn.invalid && sn.touched" class="text-red-600 text-sm">
              ⚠️ Please enter a serial number.
            </p>
          </div>
        </div>
      </div>

      <!-- ✅ Serial Numbers Selection for DECREASE -->
      <div
        *ngIf="
          stockMovementForm.value.type === 'DECREASE' &&
          availableSerialNumbers.length > 0
        "
        class="mt-4"
      >
        <h4 class="font-semibold">Select Serial Numbers to Remove:</h4>
        <div
          class="max-h-40 overflow-y-auto border border-gray-300 p-2 rounded-lg"
        >
          <div *ngFor="let serial of availableSerialNumbers">
            <label class="flex items-center">
              <input
                type="checkbox"
                [checked]="selectedSerialNumbers.includes(serial)"
                (change)="toggleSerialSelection(serial)"
                class="mr-2"
              />
              {{ serial }}
            </label>
          </div>
        </div>
      </div>

      <!-- ✅ Buttons -->
      <div class="mt-6 flex justify-end space-x-4">
        <button
          type="button"
          (click)="closeModal()"
          class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-700"
        >
          Cancel
        </button>

        <!-- ✅ Disable Update Stock Button When Errors Exist -->
        <button
          type="submit"
          [disabled]="!isFormValid() || stockMovementForm.invalid"
          class="px-4 py-2 rounded-lg transition duration-300 font-semibold"
          [ngClass]="
            isFormValid() && stockMovementForm.valid
              ? 'bg-green-600 text-white hover:bg-green-700'
              : 'bg-gray-400 text-gray-200 cursor-not-allowed'
          "
        >
          Update Stock
        </button>
      </div>
    </form>
  </div>
</div>
