<div class="p-6">
  <h2 class="text-4xl font-extrabold text-blue-900 mb-6 text-center">
    üõ†Ô∏è Job Orders
  </h2>

  <!-- ‚úÖ Search, Filters, and Action Buttons -->
  <div
    class="flex flex-wrap items-center justify-between gap-4 mb-6 bg-gray-100 p-6 rounded-lg shadow-md"
  >
    <input
      type="text"
      [(ngModel)]="searchQuery"
      (input)="searchUpdated.next(searchQuery)"
      placeholder="üîç Search Job Order ID or Client..."
      class="border border-gray-300 focus:ring-blue-500 focus:border-blue-500 px-4 py-2 rounded-lg w-full sm:w-80"
    />

    <div class="flex space-x-4">
      <button
        (click)="exportToExcel()"
        class="bg-green-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 font-semibold flex items-center gap-2"
      >
        üì§ Export
      </button>

      <button
        (click)="openModal()"
        class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 font-semibold flex items-center gap-2"
      >
        ‚ûï Add Job Order
      </button>
    </div>
  </div>

  <!-- ‚úÖ Job Orders Table -->
  <div class="overflow-x-auto bg-white shadow-lg rounded-lg">
    <table class="w-full text-left border-collapse">
      <thead>
        <tr class="bg-blue-900 text-white">
          <th
            class="px-5 py-3 cursor-pointer"
            (click)="sortTable('jobOrderID')"
          >
            Job Order ID
            <span *ngIf="sortColumn === 'jobOrderID'">
              {{ sortDirection === "asc" ? "üîº" : "üîΩ" }}
            </span>
          </th>
          <th
            class="px-5 py-3 cursor-pointer"
            (click)="sortTable('clientName')"
          >
            Client
            <span *ngIf="sortColumn === 'clientName'">
              {{ sortDirection === "asc" ? "üîº" : "üîΩ" }}
            </span>
          </th>
          <th class="px-5 py-3">Address</th>
          <th class="px-5 py-3">Contact Number</th>
          <th class="px-5 py-3">Description</th>
          <th
            class="px-5 py-3 cursor-pointer"
            (click)="sortTable('installationDate')"
          >
            Installation Date
            <span *ngIf="sortColumn === 'installationDate'">
              {{ sortDirection === "asc" ? "üîº" : "üîΩ" }}
            </span>
          </th>
          <th class="px-5 py-3 cursor-pointer" (click)="sortTable('status')">
            Status
            <span *ngIf="sortColumn === 'status'">
              {{ sortDirection === "asc" ? "üîº" : "üîΩ" }}
            </span>
          </th>
          <th class="px-5 py-3 text-center w-24">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        <tr
          *ngFor="let jobOrder of jobOrders"
          class="hover:bg-gray-100 transition"
        >
          <td class="px-5 py-3">{{ jobOrder.jobOrderID }}</td>
          <td class="px-5 py-3">{{ jobOrder.clientName }}</td>
          <td class="px-5 py-3">{{ jobOrder.address }}</td>
          <td class="px-5 py-3">{{ jobOrder.contactInfo }}</td>
          <td class="px-5 py-3">{{ jobOrder.description }}</td>
          <td class="px-5 py-3">
            {{ jobOrder.installationDate | date : "mediumDate" }}
          </td>
          <td class="px-5 py-3 font-extrabold text-sm">
            <span [ngClass]="getBadgeClasses(jobOrder.status)">
              {{ jobOrder.status }}
            </span>
          </td>
          <td class="px-5 py-3">
            <div class="flex justify-center space-x-2">
              <ng-container
                *ngIf="
                  !(
                    jobOrder.status === 'Completed' ||
                    jobOrder.status === 'Cancelled'
                  )
                "
              >
                <button
                  (click)="editJobOrder(jobOrder)"
                  class="p-1 rounded transition w-10 flex justify-center"
                >
                  <img
                    src="./Edit.png"
                    class="w-5 h-5 hover:opacity-80 transition"
                  />
                </button>
              </ng-container>
              <ng-container *ngIf="jobOrder.status !== 'Completed'">
                <button
                  (click)="openDeleteModal(jobOrder._id)"
                  class="p-1 rounded transition w-10 flex justify-center"
                >
                  <img
                    src="./Delete.png"
                    class="w-5 h-5 hover:opacity-80 transition"
                  />
                </button>
              </ng-container>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="jobOrders.length === 0" class="p-6 text-center text-gray-500">
    No job orders found.
  </div>

  <!-- ‚úÖ Pagination Controls -->
  <div class="flex justify-between items-center mt-6">
    <button
      (click)="goToPage(currentPage - 1)"
      [disabled]="currentPage === 1"
      class="bg-gray-300 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-400 disabled:opacity-50"
    >
      ‚óÄ Previous
    </button>
    <span class="text-gray-700 font-medium"
      >Page {{ currentPage }} of {{ totalPages }}</span
    >
    <button
      (click)="goToPage(currentPage + 1)"
      [disabled]="currentPage === totalPages"
      class="bg-gray-300 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-400 disabled:opacity-50"
    >
      Next ‚ñ∂
    </button>
  </div>
</div>

<!-- Custom Validation Modal -->
<div
  *ngIf="showValidationModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
>
  <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
    <h4 class="text-lg font-semibold mb-4">Validation Error</h4>
    <p class="text-gray-700 mb-4">{{ validationError }}</p>
    <button
      (click)="closeValidationModal()"
      class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
    >
      OK
    </button>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div
  *ngIf="showDeleteModal"
  class="fixed inset-0 z-[9999] flex items-center justify-center bg-auto bg-opacity-50"
>
  <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
    <h4 class="text-lg font-semibold mb-4">Confirm Deletion</h4>
    <p class="text-gray-700 mb-4">
      Are you sure you want to delete this Job Order? This action cannot be
      undone.
    </p>
    <div class="flex justify-end space-x-2">
      <button
        (click)="confirmDelete()"
        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded"
      >
        Delete
      </button>
      <button
        (click)="cancelDelete()"
        class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded"
      >
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Submit Confirmation Modal -->
<div
  *ngIf="showSubmitModal"
  class="fixed inset-0 z-[9999] flex items-center justify-center bg-auto bg-opacity-50"
>
  <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
    <h4 class="text-lg font-semibold mb-4">Confirm Submission</h4>
    <p class="text-gray-700 mb-4">
      Are you sure you want to submit this Job Order?
    </p>
    <div class="flex justify-end space-x-2">
      <button
        (click)="confirmSubmit()"
        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded"
      >
        Submit
      </button>
      <button
        (click)="cancelSubmit()"
        class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded"
      >
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Job Order Modal (for Add/Edit) -->
<div
  *ngIf="isModalOpen"
  class="fixed inset-0 z-50 flex items-center justify-center overflow-auto"
>
  <!-- Modal Container -->
  <div
    class="relative bg-white rounded-lg shadow-2xl w-full max-w-xl mx-4 max-h-screen overflow-hidden scale-90 opacity-0 transition-all duration-300"
    [ngClass]="{ 'scale-100 opacity-100': isModalOpen }"
  >
    <!-- Modal Header -->
    <div class="p-6 text-black rounded-t-lg flex justify-between items-center">
      <h3 class="text-xl font-semibold">
        {{ isEditMode ? "‚úè Edit Job Order" : "‚ûï Add New Job Order" }}
      </h3>
      <button
        (click)="closeModal()"
        class="text-red-500 text-2xl hover:text-red-600 transition"
      >
        ‚úñ
      </button>
    </div>

    <!-- Scrollable Modal Body -->
    <div class="p-6 overflow-y-auto" style="max-height: calc(100vh - 220px)">
      <form [formGroup]="jobOrderForm" class="space-y-5">
        <!-- üîç Sale Search -->
        <div>
          <label for="saleSearch" class="block text-gray-700 font-semibold">
            Select Sale
          </label>
          <input
            id="saleSearch"
            type="text"
            [(ngModel)]="saleSearchQuery"
            [ngModelOptions]="{ standalone: true }"
            (input)="filterSales()"
            (keydown)="onSaleSearchKeyDown($event)"
            [disabled]="isEditMode"
            placeholder="Search by Client Name or Sale ID"
            class="mt-1 block w-full px-4 py-2 rounded-md border border-gray-300 focus:ring focus:ring-blue-200 transition"
          />
          <div
            *ngIf="showSalesDropdown && filteredSales.length > 0"
            class="border border-gray-300 bg-white mt-1 max-h-40 overflow-y-auto shadow-md rounded-md"
          >
            <div
              *ngFor="let sale of filteredSales; let i = index"
              (click)="selectSale(sale)"
              [class.bg-gray-200]="i === selectedSaleIndex"
              class="cursor-pointer hover:bg-gray-100 px-3 py-2 transition"
            >
              üè∑Ô∏è {{ sale.clientName }} ({{ sale.saleID }})
            </div>
          </div>
        </div>

        <!-- üìç Address -->
        <div>
          <label for="address" class="block text-gray-700 font-semibold"
            >Address</label
          >
          <input
            id="address"
            formControlName="address"
            type="text"
            class="mt-1 block w-full px-4 py-2 rounded-md border border-gray-300 focus:ring focus:ring-blue-200 transition"
          />
          <p
            *ngIf="
              jobOrderForm.get('address')?.invalid &&
              jobOrderForm.get('address')?.touched
            "
            class="text-red-500 text-xs mt-1"
          >
            Address is required (Min: 5 characters).
          </p>
        </div>

        <!-- üìû Contact Info -->
        <div>
          <label for="contactInfo" class="block text-gray-700 font-semibold"
            >Contact Info</label
          >
          <input
            id="contactInfo"
            formControlName="contactInfo"
            type="text"
            class="mt-1 block w-full px-4 py-2 rounded-md border border-gray-300 focus:ring focus:ring-blue-200 transition"
          />
          <p
            *ngIf="
              jobOrderForm.get('contactInfo')?.invalid &&
              jobOrderForm.get('contactInfo')?.touched
            "
            class="text-red-500 text-xs mt-1"
          >
            Contact Info must be numeric.
          </p>
        </div>

        <!-- üìù Description -->
        <div>
          <label for="description" class="block text-gray-700 font-semibold"
            >Description</label
          >
          <textarea
            id="description"
            formControlName="description"
            rows="3"
            class="mt-1 block w-full px-4 py-2 rounded-md border border-gray-300 focus:ring focus:ring-blue-200 transition"
          ></textarea>
          <p
            *ngIf="
              jobOrderForm.get('description')?.invalid &&
              jobOrderForm.get('description')?.touched
            "
            class="text-red-500 text-xs mt-1"
          >
            Description is required (Min: 10 characters).
          </p>
        </div>

        <!-- üìÖ Installation Date -->
        <div>
          <label
            for="installationDate"
            class="block text-gray-700 font-semibold"
            >Installation Date</label
          >
          <input
            id="installationDate"
            formControlName="installationDate"
            type="date"
            class="mt-1 block w-full px-4 py-2 rounded-md border border-gray-300 focus:ring focus:ring-blue-200 transition"
          />
          <p
            *ngIf="
              jobOrderForm.get('installationDate')?.invalid &&
              jobOrderForm.get('installationDate')?.touched
            "
            class="text-red-500 text-xs mt-1"
          >
            Installation Date is required.
          </p>
        </div>

        <!-- ‚ö° Status -->
        <div>
          <label for="status" class="block text-gray-700 font-semibold"
            >Status</label
          >
          <select
            id="status"
            formControlName="status"
            class="mt-1 block w-full px-4 py-2 rounded-md border border-gray-300 focus:ring focus:ring-blue-200 transition"
          >
            <option value="">Select Status</option>
            <option value="Pending">In-progress</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
          </select>
          <p
            *ngIf="
              jobOrderForm.get('status')?.invalid &&
              jobOrderForm.get('status')?.touched
            "
            class="text-red-500 text-xs mt-1"
          >
            Status is required.
          </p>
        </div>
      </form>
    </div>

    <!-- ‚úÖ Modal Footer (Sticky Submit Button) -->
    <div
      class="p-4 border-t border-gray-200 bg-gray-50 flex items-center justify-end"
    >
      <button
        type="button"
        (click)="handleSubmit()"
        [disabled]="jobOrderForm.invalid"
        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg focus:outline-none focus:ring focus:ring-green-200 transition"
      >
        {{ isEditMode ? "üìå Update Job Order" : "‚úÖ Submit Job Order" }}
      </button>
    </div>
  </div>
</div>
